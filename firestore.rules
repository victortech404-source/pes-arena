rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {
    // Helper functions for cleaner rules
    function isAuthenticated() {
      return request.auth != null;
    }
    
    function isSuperAdmin() {
      return isAuthenticated() && request.auth.token.email == 'victortech404@gmail.com';
    }
    
    function isOrganizer() {
      return isAuthenticated() && 
             get(/databases/$(database)/documents/users/$(request.auth.uid)).data.isOrganizer == true;
    }
    
    function isModerator() {
      return isAuthenticated() && 
             get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role == 'moderator';
    }
    
    function isBoardMember() {
      return isAuthenticated() && (
        isSuperAdmin() ||
        isModerator() ||
        isOrganizer() ||
        get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role == 'superAdmin' ||
        get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role == 'boardMember'
      );
    }
    
    function isTournamentOrganizer(tournamentId) {
      return isAuthenticated() && 
             get(/databases/$(database)/documents/tournaments/$(tournamentId)).data.organizerId == request.auth.uid;
    }
    
    // User Rules - PRESERVED and enhanced
    match /users/{userId} {
      allow read: if true; // Public access for leaderboards and profiles
      allow write: if isAuthenticated() && (
        request.auth.uid == userId || 
        isSuperAdmin()
      );
    }
    
    // News Collection Rules - PRESERVED
    match /news/{newsId} {
      // Allow everyone to read (for the public facing news page)
      allow read: if true; 
      
      // Allow ALL write operations (create, update, delete) only by the Admin
      allow write: if isSuperAdmin();
    }
    
    // Feedback Collection - PRESERVED
    match /feedback/{feedbackId} {
      allow create: if isAuthenticated();
      // Added read access for super admin to view feedback
      allow read, update, delete: if isSuperAdmin();
    }
    
    // Players collection (for trending players) - PRESERVED
    match /players/{playerId} {
      allow read: if true;
      allow write: if isAuthenticated();
    }
    
    // Leaderboard collection - PRESERVED
    match /leaderboard/{entryId} {
      allow read: if true;
      allow write: if isAuthenticated();
    }
    
    // Tournament Registrations - PRESERVED but enhanced
    match /tournamentRegistrations/{registrationId} {
      allow read: if true; // Keep public read
      allow create: if isAuthenticated();
      // Enhanced update: Allow users to update their own, or organizers to update tournament registrations
      allow update: if isAuthenticated() && (
        resource.data.userId == request.auth.uid ||
        (resource.data.tournamentId != null && 
         isTournamentOrganizer(resource.data.tournamentId)) ||
        isSuperAdmin()
      );
      // Allow delete only by super admin
      allow delete: if isSuperAdmin();
    }
    
    // Tournaments - PRESERVED but enhanced with RBAC
    match /tournaments/{tournamentId} {
      allow read: if true; // Public read
      
      // Only organizers can create tournaments
      allow create: if isAuthenticated() && isOrganizer();
      
      // Update rules with proper restrictions
      allow update: if isAuthenticated() && (
        // Super admin can update anything
        isSuperAdmin() ||
        // Tournament organizer can update non-critical fields
        (isTournamentOrganizer(tournamentId) && 
         !request.resource.data.diff(resource.data).affectedKeys()
           .hasAny(['isDeleted', 'createdBy', 'organizerId']))
      );
      
      // Only super admin can delete tournaments
      allow delete: if isSuperAdmin();
    }
    
    // Player stats - PRESERVED
    match /playerStats/{userId} {
      allow read: if true;
      allow write: if isAuthenticated() && request.auth.uid == userId;
    }
    
    // Matches - PRESERVED but enhanced
    match /matches/{matchId} {
      allow read: if true; // Public read for leaderboard
      
      // Players can create a match if their uid is in userId or opponentId
      allow create: if isAuthenticated() && (
        request.resource.data.userId == request.auth.uid ||
        request.resource.data.opponentId == request.auth.uid
      );
      
      // Update rules with proper restrictions
      allow update: if isAuthenticated() && (
        // Players can update their own matches (except status)
        (resource.data.userId == request.auth.uid ||
         resource.data.opponentId == request.auth.uid) &&
        !request.resource.data.diff(resource.data).affectedKeys()
          .hasAny(['status', 'approvedBy', 'approvedAt'])
        ||
        // Only admins or tournament organizers can approve matches
        (request.resource.data.diff(resource.data).affectedKeys()
          .hasAny(['status', 'approvedBy', 'approvedAt']) &&
         (isSuperAdmin() || 
          (resource.data.tournamentId != null && 
           isTournamentOrganizer(resource.data.tournamentId))))
      );
      
      // Only super admin can delete matches
      allow delete: if isSuperAdmin();
    }
    
    // Boardroom Messages Collection - NEW
    match /boardroom_messages/{messageId} {
      // Only board members can read/write boardroom messages
      allow read: if isBoardMember();
      allow write: if isBoardMember();
    }
    
    // Allow any other collections to maintain backward compatibility
    match /{document=**} {
      allow read: if true;
      allow write: if isAuthenticated();
    }
  }
}